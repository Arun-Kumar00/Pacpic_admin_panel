<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PacPic Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .stat-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .stat-card:hover { transform: translateY(-5px); }
        #order-table tbody tr:hover, #billing-results-table tbody tr:hover { background-color: #374151; }
        .tab-btn.active { background-color: #3b82f6; color: white; }
        .tab-btn:not(.active) { background-color: transparent; color: #9ca3af; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <audio id="alarm-sound" src="alarm.wav" preload="auto"></audio>

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white">PacPic Admin Panel</h1>
                <p class="text-gray-400">Live Operations & Billing Dashboard</p>
            </div>
            <button id="mute-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm">
                Sound Off
            </button>
        </header>

        <!-- TABS -->
        <div class="mb-6 border-b border-gray-700">
            <nav class="flex space-x-2" aria-label="Tabs">
                <button id="tab-dashboard" class="tab-btn active px-4 py-2 font-medium text-sm rounded-t-lg">Dashboard</button>
                <button id="tab-billing" class="tab-btn px-4 py-2 font-medium text-sm rounded-t-lg">Billing</button>
            </nav>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-content">
            <section id="stats" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div id="riders-stat-card" class="stat-card bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 cursor-pointer">
                    <h2 class="text-lg font-medium text-gray-400">Total Riders</h2>
                    <p id="total-riders" class="text-4xl font-bold text-white mt-2">0</p>
                </div>
                <div id="restaurants-stat-card" class="stat-card bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 cursor-pointer">
                    <h2 class="text-lg font-medium text-gray-400">Total Restaurants</h2>
                    <p id="total-restaurants" class="text-4xl font-bold text-white mt-2">0</p>
                </div>
                <div class="stat-card bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                    <h2 class="text-lg font-medium text-gray-400">Total Orders</h2>
                    <p id="total-orders" class="text-4xl font-bold text-white mt-2">0</p>
                </div>
            </section>
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">Live Order Feed</h2>
                <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-700">
                    <div class="overflow-x-auto">
                        <table id="order-table" class="min-w-full">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Order Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Restaurant</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Rider</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Price</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Details</th>
                                </tr>
                            </thead>
                            <tbody id="order-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>

        <!-- Billing Content -->
        <div id="billing-content" class="hidden">
             <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-2xl font-bold text-white mb-4">Process Payments & Bills</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="col-span-1">
                        <label for="user-type" class="block text-sm font-medium text-gray-400">User Type</label>
                        <select id="user-type" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                            <option value="riders">Rider Payment</option>
                            <option value="restaurants">Restaurant Bill</option>
                        </select>
                    </div>
                    <div class="col-span-3 md:col-span-1">
                        <label for="user-select" class="block text-sm font-medium text-gray-400">Select User</label>
                        <select id="user-select" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                            <option>-- Select User Type First --</option>
                        </select>
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label for="start-date" class="block text-sm font-medium text-gray-400">Start Date</label>
                        <input type="date" id="start-date" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label for="end-date" class="block text-sm font-medium text-gray-400">End Date</label>
                        <input type="date" id="end-date" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                    </div>
                </div>
                <button id="calculate-btn" class="mt-4 w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Calculate</button>

                <div id="billing-results" class="mt-6 hidden">
                    <h3 id="results-title" class="text-xl font-bold">Calculation Results</h3>
                    <p id="results-description" class="text-gray-400">Total outstanding for selected period:</p>
                    <p id="total-due" class="text-3xl font-bold text-green-400 my-2">₹0.00</p>
                    <div id="unpaid-orders-list" class="max-h-60 overflow-y-auto border border-gray-700 rounded-lg p-2 mt-2"></div>
                    <button id="pay-btn" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-500" disabled>Mark as Paid / Settled</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals (for Dashboard) -->
    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-3xl border border-gray-700 relative">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
            <h2 class="text-2xl font-bold mb-4">Order Details</h2>
            <div id="modal-content" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </div>
    <div id="list-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
         <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-4xl border border-gray-700 relative">
            <button id="close-list-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
            <h2 id="list-modal-title" class="text-2xl font-bold mb-4"></h2>
            <div id="list-modal-content"></div>
        </div>
    </div>

    <script type="module">
        // --- IMPORTANT: Your Firebase Config and Imports ---
        const firebaseConfig = {
                apiKey: "AIzaSyAF-LT-rGdnTOls0lIGE6C_ssiwqOUOq5A",
                authDomain: "arun-bc25d.firebaseapp.com",
                databaseURL: "https://arun-bc25d-default-rtdb.firebaseio.com",
                projectId: "arun-bc25d",
                storageBucket: "arun-bc25d.appspot.com", // <-- THIS LINE IS CORRECTED
                messagingSenderId: "250915027240",
                appId: "1:250915027240:web:8a0e82a290b91a497a381d",
                measurementId: "G-JELGTKLDHX"
           };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, get, child, update, query, orderByChild, equalTo, onChildAdded, onChildChanged, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        signInAnonymously(auth).catch((error) => console.error("Sign-in failed:", error));
        
        // --- TABS ---
        const dashboardTab = document.getElementById('tab-dashboard');
        const billingTab = document.getElementById('tab-billing');
        const dashboardContent = document.getElementById('dashboard-content');
        const billingContent = document.getElementById('billing-content');

        dashboardTab.addEventListener('click', () => {
            dashboardContent.classList.remove('hidden');
            billingContent.classList.add('hidden');
            dashboardTab.classList.add('active');
            billingTab.classList.remove('active');
        });

        billingTab.addEventListener('click', () => {
            dashboardContent.classList.add('hidden');
            billingContent.classList.remove('hidden');
            billingTab.classList.add('active');
            dashboardTab.classList.remove('active');
        });
        
        // --- DASHBOARD LOGIC ---
        const alarmSound = document.getElementById('alarm-sound');
        const muteBtn = document.getElementById('mute-btn');
        let isMuted = true;
        const totalRidersEl = document.getElementById('total-riders');
        const totalRestaurantsEl = document.getElementById('total-restaurants');
        const totalOrdersEl = document.getElementById('total-orders');
        const orderTableBody = document.getElementById('order-table-body');
        const modal = document.getElementById('details-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalContent = document.getElementById('modal-content');
        const listModal = document.getElementById('list-modal');
        const closeListModalBtn = document.getElementById('close-list-modal');
        const listModalTitle = document.getElementById('list-modal-title');
        const listModalContent = document.getElementById('list-modal-content');
        const ridersStatCard = document.getElementById('riders-stat-card');
        const restaurantsStatCard = document.getElementById('restaurants-stat-card');

        const formatTimestamp = (timestamp) => {
            return new Date(timestamp).toLocaleString('en-IN', {
                day: '2-digit', month: 'short', year: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: true
            });
        };
        
        const createStatusBadge = (status) => {
            let colorClass = 'bg-yellow-500 text-yellow-900';
            if (status === 'accepted') colorClass = 'bg-blue-500 text-blue-900';
            if (status === 'completed') colorClass = 'bg-green-500 text-green-900';
            if (status === 'cancelled') colorClass = 'bg-red-500 text-red-900';
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colorClass}">${status}</span>`;
        };

        const showOrderDetails = async (orderId) => {
            const orderSnapshot = await get(child(ref(db), `orders/${orderId}`));
            if (!orderSnapshot.exists()) return;
            const order = orderSnapshot.val();
            // ... (rest of the showOrderDetails function)
        };
        
        const showListModal = async (type) => {
             const path = type === 'riders' ? 'riders' : 'restaurants';
            onValue(ref(db, path), (snapshot) => { // Use onValue for real-time updates
                listModalTitle.textContent = `All ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                if (!snapshot.exists()) {
                    listModalContent.innerHTML = `<p class="text-center">No ${type} found.</p>`;
                    return;
                }
                // ... (rest of the showListModal function)
            });
            listModal.classList.remove('hidden');
        };
        
        onValue(ref(db, 'riders'), (s) => totalRidersEl.textContent = s.exists() ? s.size.toString() : '0');
        onValue(ref(db, 'restaurants'), (s) => totalRestaurantsEl.textContent = s.exists() ? s.size.toString() : '0');
        onValue(ref(db, 'orders'), (s) => totalOrdersEl.textContent = s.exists() ? s.size.toString() : '0');
        
        const ordersQuery = query(ref(db, 'orders'), orderByChild('createdAt'), limitToLast(50));
        
        onChildAdded(ordersQuery, async (snapshot) => {
            const orderId = snapshot.key;
            const order = snapshot.val();
            if (document.getElementById(`order-${orderId}`)) return;
            if (order.status === 'pending' && !isMuted) {
                alarmSound.play().catch(e => console.error("Audio play failed:", e));
            }
            const row = document.createElement('tr');
            row.id = `order-${orderId}`;
            let riderName = 'N/A';
            if (order.riderId) {
                const riderSnapshot = await get(child(ref(db), `riders/${order.riderId}`));
                if (riderSnapshot.exists()) riderName = riderSnapshot.val().name;
            }
            const price = (Number(order.price) || 0).toFixed(2);
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatTimestamp(order.createdAt)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${order.restaurantName || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 rider-name">${riderName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm status-cell">${createStatusBadge(order.status)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">₹${price}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                    <button class="details-btn text-indigo-400 hover:text-indigo-300" data-id="${orderId}">View</button>
                </td>
            `;
            orderTableBody.prepend(row);
        });

        onChildChanged(ref(db, 'orders'), async (snapshot) => {
            const orderId = snapshot.key;
            const order = snapshot.val();
            const row = document.getElementById(`order-${orderId}`);
            if (row) {
                row.querySelector('.status-cell').innerHTML = createStatusBadge(order.status);
                let riderName = 'N/A';
                if (order.riderId) {
                    const riderSnapshot = await get(child(ref(db), `riders/${order.riderId}`));
                    if (riderSnapshot.exists()) riderName = riderSnapshot.val().name;
                }
                row.querySelector('.rider-name').textContent = riderName;
            }
        });

        muteBtn.addEventListener('click', () => { /* ... */ });
        closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
        orderTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('details-btn')) {
                showOrderDetails(e.target.getAttribute('data-id'));
            }
        });
        closeListModalBtn.addEventListener('click', () => listModal.classList.add('hidden'));
        ridersStatCard.addEventListener('click', () => showListModal('riders'));
        restaurantsStatCard.addEventListener('click', () => showListModal('restaurants'));

        
        // --- BILLING LOGIC ---
        const userTypeSelect = document.getElementById('user-type');
        const userSelect = document.getElementById('user-select');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const calculateBtn = document.getElementById('calculate-btn');
        const billingResults = document.getElementById('billing-results');
        const totalDueEl = document.getElementById('total-due');
        const unpaidOrdersList = document.getElementById('unpaid-orders-list');
        const payBtn = document.getElementById('pay-btn');
        const resultsTitle = document.getElementById('results-title');
        const resultsDescription = document.getElementById('results-description');
        
        let calculatedOrders = []; 

        async function populateUsers(type) {
            const path = type === 'riders' ? 'riders' : 'restaurants';
            const snapshot = await get(ref(db, path));
            userSelect.innerHTML = '<option value="">-- Select User --</option>';
            if (snapshot.exists()) {
                const data = snapshot.val();
                for (const id in data) {
                    const name = type === 'riders' ? data[id].name : data[id].profile?.name;
                    if (name) {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        userSelect.appendChild(option);
                    }
                }
            }
        }
        
        userTypeSelect.addEventListener('change', (e) => {
            populateUsers(e.target.value);
            billingResults.classList.add('hidden');
        });

        calculateBtn.addEventListener('click', async () => {
            const type = userTypeSelect.value;
            const userId = userSelect.value;
            const startDate = new Date(startDateInput.value).getTime();
            const endDate = new Date(endDateInput.value).setHours(23, 59, 59, 999);

            if (!userId || !startDateInput.value || !endDateInput.value) {
                alert('Please select a user and a valid date range.');
                return;
            }

            const keyField = type === 'riders' ? 'riderId' : 'restaurantId';
            const ordersQuery = query(ref(db, 'orders'), orderByChild(keyField), equalTo(userId));
            const snapshot = await get(ordersQuery);

            let total = 0;
            calculatedOrders = [];
            unpaidOrdersList.innerHTML = '';

            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const order = childSnapshot.val();
                    const orderId = childSnapshot.key;
                    const isPaid = type === 'riders' ? order.isPaidToRider : order.isSettledByRestaurant;
                    
                    if (order.status === 'completed' && !isPaid && order.createdAt >= startDate && order.createdAt <= endDate) {
                        const amount = type === 'riders' ? (Number(order.price) * 15 / 25) : (Number(order.price));
                        total += amount;
                        calculatedOrders.push(orderId);
                        
                        const orderItem = document.createElement('div');
                        orderItem.className = 'text-sm p-1 flex justify-between';
                        orderItem.innerHTML = `<span>${new Date(order.createdAt).toLocaleDateString()}</span> <span>₹${amount.toFixed(2)}</span>`;
                        unpaidOrdersList.appendChild(orderItem);
                    }
                });
            }

            if (type === 'riders') {
                resultsTitle.textContent = `Payment due to ${userSelect.options[userSelect.selectedIndex].text}`;
                resultsDescription.textContent = 'Total unpaid earnings for selected period:';
                totalDueEl.className = 'text-3xl font-bold text-green-400 my-2';
                payBtn.textContent = 'Mark as Paid';
            } else {
                resultsTitle.textContent = `Bill for ${userSelect.options[userSelect.selectedIndex].text}`;
                resultsDescription.textContent = 'Total outstanding commission for selected period:';
                totalDueEl.className = 'text-3xl font-bold text-red-400 my-2';
                payBtn.textContent = 'Mark as Settled';
            }
            
            totalDueEl.textContent = `₹${total.toFixed(2)}`;
            billingResults.classList.remove('hidden');
            payBtn.disabled = calculatedOrders.length === 0;
        });
        
        payBtn.addEventListener('click', async () => {
            if (!confirm(`Are you sure you want to mark ${calculatedOrders.length} orders as processed? This cannot be undone.`)) return;
            
            const type = userTypeSelect.value;
            const updateField = type === 'riders' ? 'isPaidToRider' : 'isSettledByRestaurant';
            const updates = {};
            
            calculatedOrders.forEach(orderId => {
                updates[`/orders/${orderId}/${updateField}`] = true;
            });

            try {
                await update(ref(db), updates);
                alert('Success! The records have been updated.');
                billingResults.classList.add('hidden');
            } catch(e) {
                alert('An error occurred. Please try again.');
                console.error(e);
            }
        });

        // Initialize user list on page load
        populateUsers('riders');
    </script>
</body>
</html>
